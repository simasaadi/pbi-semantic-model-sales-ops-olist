<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Olist Sales Ops Dashboard</title>
  <style>
    :root{
      --bg:#0b1220; --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62);
      --chip:rgba(59,130,246,.18); --chipText:rgba(191,219,254,.95);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 65% 10%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(900px 500px at 15% 25%, rgba(16,185,129,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
    h1{margin:0 0 6px;font-size:26px;letter-spacing:.2px}
    .sub{margin:0 0 18px;color:var(--muted);max-width:880px;line-height:1.45}
    .row{display:grid;gap:12px}
    .filters{grid-template-columns:1.15fr 1.15fr 1fr 1fr; align-items:end}
    .cards{grid-template-columns:1fr 1fr 1fr 1fr}
    .grid2{grid-template-columns:1.25fr .95fr}
    .grid2b{grid-template-columns:1fr 1fr}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
    }
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input, select{
      width:100%;
      background: rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    option{color:#111}
    .cardTitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .chip{
      font-size:12px;padding:4px 9px;border-radius:999px;
      border:1px solid rgba(59,130,246,.35);
      background:var(--chip); color:var(--chipText);
    }
    .kpi{font-size:26px;font-weight:700;letter-spacing:.2px;margin-top:4px}
    .kpiSub{color:var(--muted);font-size:12px;margin-top:2px}
    .titleRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .titleRow h3{margin:0;font-size:14px}
    .titleRow .hint{color:var(--muted);font-size:12px}
    canvas{width:100%;height:320px;display:block}
    .small canvas{height:280px}

    .footer{display:flex;gap:10px;align-items:center;margin:10px 2px 0;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(59,130,246,.7)}
    .loading{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin-top:6px}
    .spinner{width:10px;height:10px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:rgba(255,255,255,.75);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .error{
      background: rgba(251,113,133,.12);
      border:1px solid rgba(251,113,133,.35);
      color: rgba(255,255,255,.92);
      padding:10px 12px;border-radius:12px;margin:14px 0 0;display:none;
      white-space:pre-wrap;
    }

    @media (max-width: 1000px){
      .filters{grid-template-columns:1fr 1fr}
      .cards{grid-template-columns:1fr 1fr}
      .grid2,.grid2b{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Olist Sales Ops Dashboard</h1>
    <p class="sub">
      Interactive view of revenue, order volume, category mix, delivery performance, and cohort behavior.
      Use filters to explore time windows, states, and order statuses.
    </p>

    <div class="row filters">
      <div class="panel">
        <label for="start">Start date</label>
        <input id="start" type="date" />
      </div>
      <div class="panel">
        <label for="end">End date</label>
        <input id="end" type="date" />
      </div>
      <div class="panel">
        <label for="state">Customer state</label>
        <select id="state"></select>
      </div>
      <div class="panel">
        <label for="status">Order status</label>
        <select id="status"></select>
      </div>
    </div>

    <div class="row cards" style="margin-top:12px">
      <div class="panel">
        <div class="cardTitle"><div style="color:var(--muted);font-size:12px">Revenue</div><div class="chip" id="chipScopeA">All</div></div>
        <div class="kpi" id="kpiRevenue">—</div>
        <div class="kpiSub">Total item price (scope)</div>
      </div>
      <div class="panel">
        <div class="cardTitle"><div style="color:var(--muted);font-size:12px">Orders</div><div class="chip" id="chipScopeB">All</div></div>
        <div class="kpi" id="kpiOrders">—</div>
        <div class="kpiSub">Distinct orders (scope)</div>
      </div>
      <div class="panel">
        <div class="cardTitle"><div style="color:var(--muted);font-size:12px">Avg order value</div><div class="chip" id="chipScopeC">All</div></div>
        <div class="kpi" id="kpiAOV">—</div>
        <div class="kpiSub">Revenue / orders</div>
      </div>
      <div class="panel">
        <div class="cardTitle"><div style="color:var(--muted);font-size:12px">Avg delivery days</div><div class="chip">Delivered</div></div>
        <div class="kpi" id="kpiDelivery">—</div>
        <div class="kpiSub">Delivered orders only</div>
      </div>
    </div>

    <div class="row grid2" style="margin-top:12px">
      <div class="panel">
        <div class="titleRow">
          <h3>Revenue & order volume trend</h3>
          <div class="hint">Daily</div>
        </div>
        <canvas id="trend"></canvas>
      </div>
      <div class="panel small">
        <div class="titleRow">
          <h3>Top states by revenue</h3>
          <div class="hint">Top 10</div>
        </div>
        <canvas id="states"></canvas>
      </div>
    </div>

    <div class="row grid2b" style="margin-top:12px">
      <div class="panel small">
        <div class="titleRow">
          <h3>Category mix</h3>
          <div class="hint">Top 12</div>
        </div>
        <canvas id="cats"></canvas>
      </div>
      <div class="panel small">
        <div class="titleRow">
          <h3>Delivery time distribution</h3>
          <div class="hint">0–60 days (2-day bins)</div>
        </div>
        <canvas id="delivery"></canvas>
      </div>
    </div>

    <div class="footer">
      <span class="dot"></span>
      <span id="statusLine">Ready.</span>
      <span class="loading" id="loading" style="display:none"><span class="spinner"></span>Loading data…</span>
    </div>

    <div class="error" id="err"></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const fmtInt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
  const fmtMoney = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
  const fmt1 = new Intl.NumberFormat(undefined, { maximumFractionDigits: 1 });

  function setError(msg){
    const el = $("err");
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearError(){
    const el = $("err");
    el.style.display = "none";
    el.textContent = "";
  }

  // --- IMPORTANT: your JSON uses purchase_date, not order_date ---
  const getDateStr = (r) => r.purchase_date ?? r.order_date ?? r.date ?? null;
  const getState   = (r) => r.customer_state ?? r.state ?? r.customer_state_code ?? null;
  const getStatus  = (r) => r.order_status ?? r.status ?? null;

  function parseISO(d){
    if(!d) return null;
    const dt = new Date(d + "T00:00:00");
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function getCtx(canvas){
    const ctx = canvas.getContext("2d");
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    return ctx;
  }

  function drawEmpty(canvas, title){
    const ctx = getCtx(canvas);
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.font = "13px ui-sans-serif, system-ui";
    ctx.fillText(`No data available`, 14, 22);
    if(title){
      ctx.fillStyle = "rgba(255,255,255,.35)";
      ctx.fillText(title, 14, 42);
    }
  }

  function drawAxes(ctx, w, h, pad){
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h - pad);
    ctx.lineTo(w - pad, h - pad);
    ctx.stroke();
  }

  function drawLine(ctx, w, h, pad, xs, ys, color){
    if(xs.length < 2) return;
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const spanY = (maxY - minY) || 1;

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const x = pad + ((xs[i]-xs[0]) / ((xs[xs.length-1]-xs[0]) || 1)) * (w - pad*2);
      const y = (h - pad) - ((ys[i]-minY)/spanY) * (h - pad*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function drawBars(ctx, w, h, pad, labels, values, color){
    const n = values.length;
    if(!n) return;
    const maxV = Math.max(...values) || 1;
    const barW = (w - pad*2) / n;

    ctx.fillStyle = color;
    for(let i=0;i<n;i++){
      const v = values[i];
      const bh = (v / maxV) * (h - pad*2);
      const x = pad + i*barW + barW*0.12;
      const y = (h - pad) - bh;
      const bw = barW*0.76;
      ctx.fillRect(x, y, bw, bh);
    }

    ctx.fillStyle = "rgba(255,255,255,.68)";
    ctx.font = "12px ui-sans-serif, system-ui";
    const step = n > 10 ? 2 : 1;
    for(let i=0;i<n;i+=step){
      const x = pad + i*barW + barW*0.12;
      ctx.fillText(labels[i], x, h - pad + 16);
    }
  }

  const PATH = "./data/";
  const FILES = [
    "daily_overall.json",
    "daily_state_status.json",
    "top_categories.json",
    "delivery_hist.json"
  ];

  async function fetchJSON(name){
    const url = PATH + name;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`Fetch failed ${res.status}: ${url}`);
    return res.json();
  }

  const startEl = $("start");
  const endEl = $("end");
  const stateEl = $("state");
  const statusEl = $("status");

  function setLoading(on){
    $("loading").style.display = on ? "inline-flex" : "none";
    $("statusLine").textContent = on ? "Loading…" : "Ready.";
  }

  function fillSelect(sel, values, allLabel){
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__all__";
    optAll.textContent = allLabel;
    sel.appendChild(optAll);
    for(const v of values){
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    }
  }

  let dailyOverall = [];
  let dailyStateStatus = [];
  let topCategories = [];
  let deliveryHist = [];

  function scopeLabel(){
    const s = stateEl.value === "__all__" ? "All states" : stateEl.value;
    const st = statusEl.value === "__all__" ? "All statuses" : statusEl.value;
    return `${s} · ${st}`;
  }

  function apply(){
    clearError();

    const start = parseISO(startEl.value);
    const end   = parseISO(endEl.value);
    const state = stateEl.value;
    const status= statusEl.value;

    const scope = scopeLabel();
    $("chipScopeA").textContent = scope;
    $("chipScopeB").textContent = scope;
    $("chipScopeC").textContent = scope;

    // --- Trend + KPIs: use daily_overall filtered by status/date (no state available here)
    let rows = dailyOverall.filter(r => {
      const d = parseISO(getDateStr(r));
      if(!d) return false;
      if(start && d < start) return false;
      if(end && d > end) return false;
      if(status !== "__all__" && getStatus(r) !== status) return false;
      return true;
    });

    // If user selected a specific state, use daily_state_status for trend instead
    if(state !== "__all__" && dailyStateStatus.length){
      rows = dailyStateStatus.filter(r => {
        const d = parseISO(getDateStr(r));
        if(!d) return false;
        if(start && d < start) return false;
        if(end && d > end) return false;
        if(getState(r) !== state) return false;
        if(status !== "__all__" && getStatus(r) !== status) return false;
        return true;
      });
    }

    // aggregate by date
    const byDay = new Map();
    for(const r of rows){
      const k = getDateStr(r);
      if(!k) continue;
      const prev = byDay.get(k) || { revenue:0, orders:0 };
      prev.revenue += +r.revenue || 0;
      prev.orders  += +r.orders  || 0;
      byDay.set(k, prev);
    }
    const days = Array.from(byDay.keys()).sort();
    const rev = days.map(d => byDay.get(d).revenue);
    const ord = days.map(d => byDay.get(d).orders);

    const totalRev = rev.reduce((a,b)=>a+b,0);
    const totalOrders = ord.reduce((a,b)=>a+b,0);
    const aov = totalOrders ? totalRev/totalOrders : 0;

    $("kpiRevenue").textContent = totalRev ? fmtMoney.format(totalRev) : "—";
    $("kpiOrders").textContent  = totalOrders ? fmtInt.format(totalOrders) : "—";
    $("kpiAOV").textContent     = totalOrders ? fmtMoney.format(aov) : "—";

    // Avg delivery days from delivery_hist (overall only)
    if(deliveryHist.length){
      const bins = deliveryHist
        .filter(r => (+r.bin_start_days||0) <= 60)
        .sort((a,b)=>(+a.bin_start_days||0)-(+b.bin_start_days||0));
      const total = bins.reduce((a,r)=>a + (+r.count||0), 0) || 0;
      const mid = bins.reduce((a,r)=>{
        const startD = +r.bin_start_days || 0;
        const m = startD + 1;
        return a + m*(+r.count||0);
      },0);
      const avg = total ? (mid/total) : 0;
      $("kpiDelivery").textContent = total ? fmt1.format(avg) : "—";
    } else {
      $("kpiDelivery").textContent = "—";
    }

    // Trend chart
    const trendCanvas = $("trend");
    if(days.length < 2){
      drawEmpty(trendCanvas, "Trend (pick a wider date range)");
    } else {
      const ctx = getCtx(trendCanvas);
      const { width:w, height:h } = trendCanvas.getBoundingClientRect();
      ctx.clearRect(0,0,w,h);
      const pad = 28;
      drawAxes(ctx,w,h,pad);
      const xs = days.map(d => parseISO(d).getTime());
      drawLine(ctx,w,h,pad,xs,rev,"rgba(59,130,246,.9)");
      drawLine(ctx,w,h,pad,xs,ord,"rgba(16,185,129,.75)");
      ctx.fillStyle = "rgba(255,255,255,.68)";
      ctx.font = "12px ui-sans-serif, system-ui";
      ctx.fillText("Revenue", pad+6, pad+14);
      ctx.fillStyle = "rgba(16,185,129,.80)";
      ctx.fillText("Orders", pad+72, pad+14);
    }

    // Top states by revenue: ONLY from daily_state_status
    const statesCanvas = $("states");
    if(!dailyStateStatus.length){
      drawEmpty(statesCanvas, "Top states (daily_state_status.json missing)");
    } else {
      const filt = dailyStateStatus.filter(r => {
        const d = parseISO(getDateStr(r));
        if(!d) return false;
        if(start && d < start) return false;
        if(end && d > end) return false;
        if(status !== "__all__" && getStatus(r) !== status) return false;
        return true;
      });
      const byState = new Map();
      for(const r of filt){
        const s = getState(r);
        if(!s) continue;
        byState.set(s, (byState.get(s)||0) + (+r.revenue||0));
      } 
      const top = Array.from(byState.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      if(!top.length){
        drawEmpty(statesCanvas, "Top states");
      } else {
        const labels = top.map(x=>x[0]);
        const vals = top.map(x=>x[1]);
        const ctx = getCtx(statesCanvas);
        const { width:w, height:h } = statesCanvas.getBoundingClientRect();
        ctx.clearRect(0,0,w,h);
        const pad = 28;
        drawAxes(ctx,w,h,pad);
        drawBars(ctx,w,h,pad,labels,vals,"rgba(59,130,246,.75)");
      }
    }

    // Top categories
    const catsCanvas = $("cats");
    if(!topCategories.length){
      drawEmpty(catsCanvas, "Categories");
    } else {
      const top = topCategories.slice(0,12);
      const labels = top.map(r=>r.category);
      const vals = top.map(r=>+r.revenue||0);
      const ctx = getCtx(catsCanvas);
      const { width:w, height:h } = catsCanvas.getBoundingClientRect();
      ctx.clearRect(0,0,w,h);
      const pad = 28;
      drawAxes(ctx,w,h,pad);
      drawBars(ctx,w,h,pad,labels,vals,"rgba(16,185,129,.72)");
    }

    // Delivery hist
    const delCanvas = $("delivery");
    if(!deliveryHist.length){
      drawEmpty(delCanvas, "Delivery");
    } else {
      const bins = deliveryHist
        .filter(r => (+r.bin_start_days||0) <= 60)
        .sort((a,b)=>(+a.bin_start_days||0)-(+b.bin_start_days||0));
      const labels = bins.map(r => String(+r.bin_start_days||0));
      const vals = bins.map(r => +r.count||0);
      const ctx = getCtx(delCanvas);
      const { width:w, height:h } = delCanvas.getBoundingClientRect();
      ctx.clearRect(0,0,w,h);
      const pad = 28;
      drawAxes(ctx,w,h,pad);
      drawBars(ctx,w,h,pad,labels,vals,"rgba(99,102,241,.70)");
    }
  }

  async function init(){
    setLoading(true);
    clearError();
    try{
      const [a,b,c,d] = await Promise.all(FILES.map(fetchJSON));
      dailyOverall = a || [];
      dailyStateStatus = b || [];
      topCategories = c || [];
      deliveryHist = d || [];

      // build dropdowns
      const statuses = Array.from(new Set(
        [...dailyOverall, ...dailyStateStatus].map(getStatus).filter(Boolean)
      )).sort();
      fillSelect(statusEl, statuses, "All statuses");

      const states = Array.from(new Set(
        dailyStateStatus.map(getState).filter(Boolean)
      )).sort();
      fillSelect(stateEl, states, "All states");

      // set default dates from dailyOverall (purchase_date)
      const dates = dailyOverall.map(getDateStr).filter(Boolean).sort();
      if(dates.length){
        startEl.value = dates[0];
        endEl.value = dates[dates.length-1];
      }

      setLoading(false);
      apply();

      [startEl, endEl, stateEl, statusEl].forEach(el => el.addEventListener("change", apply));
      window.addEventListener("resize", apply);

    } catch(e){
      setLoading(false);
      setError(
        "Dashboard failed to load data.\n\n" +
        "Details:\n" + (e?.message || String(e))
      );
      console.error(e);
      ["trend","states","cats","delivery"].forEach(id => drawEmpty($(id)));
    }
  }

  init();
})();
</script>
</body>
</html>
